<!DOCTYPE html>
<html>
<head>
    <title>IDE en ligne</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: Arial, sans-serif; }
        #sidebar { width: 250px; padding: 10px; background: #f0f0f0; display: flex; flex-direction: column; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; }
        #editor-container { position: relative; flex-grow: 1; }
        #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
        #output { height: 150px; overflow-y: auto; background: #000; color: #fff; padding: 10px; font-family: monospace; }
        .error { color: #ff6b6b; }
        .file-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; }
        .file-list li { cursor: pointer; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
        .file-list li:hover { background: #e0e0e0; }
        .cursor { position: absolute; width: 2px; height: 15px; pointer-events: none; }
        .cursor-label { position: absolute; font-size: 10px; padding: 2px; border-radius: 3px; color: white; pointer-events: none; }
        .project-actions, .file-actions { margin-bottom: 10px; }
        button { margin: 2px; padding: 5px 10px; }
        input, select { margin-bottom: 5px; padding: 5px; width: 100%; box-sizing: border-box; }
        #save-status { position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background: #4CAF50; color: white; border-radius: 3px; display: none; }
        #terminal {
            display: flex;
            flex-direction: column;
            height: 150px;
            background: #1e1e1e;
            color: #fff;
            font-family: 'Consolas', monospace;
            padding: 10px;
            overflow: hidden;
        }
        #output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #4CAF50; }
        .error { color: #ff6b6b; }
        #terminal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #execute-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
        }
        #execute-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #clear-terminal-btn {
            background-color: #607d8b;
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
        }

        #terminals-container {
        height: 200px;
        background: #1e1e1e;
        display: flex;
        flex-direction: column;
        }

        .terminal-tabs {
            display: flex;
            background: #2d2d2d;
        }

        .terminal-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            opacity: 0.7;
        }

        .terminal-tab.active {
            opacity: 1;
            border-bottom: 2px solid #4CAF50;
        }

        .terminal {
            display: none;
            flex-direction: column;
            flex: 1;
            padding: 10px;
        }

        .terminal.active {
            display: flex;
        }

        .output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #fff;
        }

        .terminal-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="project-actions">
            <h3>Projets</h3>
            <input type="text" id="project-name" placeholder="Nom du projet">
            <button onclick="createProject()">Nouveau projet</button>
            <button onclick="deleteProject()">Supprimer projet</button>
            <select id="project-select" onchange="selectProject()">
                <option value="">Sélectionner un projet</option>
            </select>
        </div>

        <div class="file-actions">
            <h3>Fichiers</h3>
            <input type="text" id="filename" placeholder="Nom du fichier">
            <select id="file-type">
                <option value="py">Python</option>
                <option value="c">C</option>
            </select>
            <button onclick="createFile()" disabled id="create-file-btn">Nouveau fichier</button>
            <button onclick="renameFile()" disabled id="rename-file-btn">Renommer</button>
            <button onclick="deleteFile()" disabled id="delete-file-btn">Supprimer</button>
        </div>
        <ul id="file-list" class="file-list"></ul>
    </div>
    <div id="main-content">
        <div id="editor-container">
            <div id="editor"></div>
        </div>
        <div id="terminals-container">
            <div class="terminal-tabs">
                <button id="python-tab" class="terminal-tab active" onclick="switchTerminal('python')">Terminal Python</button>
                <button id="c-tab" class="terminal-tab" onclick="switchTerminal('c')">Terminal C</button>
            </div>
            <div id="python-terminal" class="terminal active">
                <pre id="python-output" class="output"></pre>
                <div class="terminal-actions">
                    <button id="execute-python-btn" class="execute-btn" onclick="executeCode('python')">Exécuter Python</button>
                    <button onclick="clearTerminal('python')" class="clear-terminal-btn">Effacer</button>
                </div>
            </div>
            <div id="c-terminal" class="terminal">
                <pre id="c-output" class="output"></pre>
                <div class="terminal-actions">
                    <button id="execute-c-btn" class="execute-btn" onclick="executeCode('c')">Compiler & Exécuter C</button>
                    <button onclick="clearTerminal('c')" class="clear-terminal-btn">Effacer</button>
                </div>
            </div>
        </div>
    </div>
    <div id="save-status">Sauvegardé</div>

    <script>
        const socket = io();
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");

        let currentFile = '';
        let currentProject = '';
        let isUpdating = false;
        let localUserId = null;
        let saveTimeout = null;
        const cursors = {};

        document.addEventListener('DOMContentLoaded', initializeUI);

        // Initialisation des boutons avant leur utilisation
        const createFileBtn = document.getElementById('create-file-btn');
        const renameFileBtn = document.getElementById('rename-file-btn');
        const deleteFileBtn = document.getElementById('delete-file-btn');
        const executeBtn = document.getElementById('execute-btn');

        editor.setReadOnly(true);

        socket.on('connect', () => {
            localUserId = socket.id;
        });

        function initializeUI() {
            // Récupération des boutons
            const executePythonBtn = document.getElementById('execute-python-btn');
            const executeCBtn = document.getElementById('execute-c-btn');
            const createFileBtn = document.getElementById('create-file-btn');
            const renameFileBtn = document.getElementById('rename-file-btn');
            const deleteFileBtn = document.getElementById('delete-file-btn');
            
            // Désactivation initiale des boutons
            executePythonBtn.disabled = true;
            executeCBtn.disabled = true;
            createFileBtn.disabled = true;
            renameFileBtn.disabled = true;
            deleteFileBtn.disabled = true;
            
            // Définir l'éditeur en lecture seule initialement
            editor.setReadOnly(true);
        }

        function createProject() {
            const projectName = document.getElementById('project-name').value;
            if (projectName) {
                socket.emit('create_project', {name: projectName});
                document.getElementById('project-name').value = '';
            }
        }

        function deleteProject() {
            if (currentProject && confirm(`Êtes-vous sûr de vouloir supprimer le projet "${currentProject}" ?`)) {
                socket.emit('delete_project', {name: currentProject});
                currentProject = '';
                currentFile = '';
                editor.setValue('');
                updateUIState();
            }
        }

        function createFile() {
            const filename = document.getElementById('filename').value;
            const fileType = document.getElementById('file-type').value;
            filename = filename +"."+ fileType;
            if (filename && currentProject) {
                socket.emit('create_file', {name: filename, project: currentProject, type: fileType});
                document.getElementById('filename').value = '';
            }
        }

        function renameFile() {
            if (currentFile && currentProject) {
                const newName = prompt('Nouveau nom du fichier:', currentFile);
                if (newName && newName !== currentFile) {
                    socket.emit('rename_file', {
                        old_name: currentFile,
                        new_name: newName,
                        project: currentProject
                    });
                }
            }
        }

        function deleteFile() {
            if (currentFile && currentProject && confirm(`Êtes-vous sûr de vouloir supprimer le fichier "${currentFile}" ?`)) {
                socket.emit('delete_file', {name: currentFile, project: currentProject});
                currentFile = '';
                editor.setValue('');
                updateUIState();
            }
        }

        function showSaveStatus() {
            const saveStatus = document.getElementById('save-status');
            saveStatus.style.display = 'block';
            setTimeout(() => {
                saveStatus.style.display = 'none';
            }, 2000);
        }

        function clearTerminal() {
            const outputElement = document.getElementById('output');
            outputElement.innerHTML = '';
        }

        socket.on('code_output', function(data) {
            // Déterminer quel terminal utiliser en fonction du type de fichier actuel
            const type = currentFile.endsWith('.c') ? 'c' : 'python';
            const outputElement = document.getElementById(`${type}-output`);

            if (data.output) {
                outputElement.innerHTML += `<span>${data.output}</span>`;
            }

            if (data.error) {
                outputElement.innerHTML += `<span class="error">${data.error}</span>`;
            }

            // Faire défiler vers le bas
            outputElement.scrollTop = outputElement.scrollHeight;
        });

        editor.session.on('change', function(delta) {
            if (!isUpdating && currentProject && currentFile) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    socket.emit('save_file', {
                        project: currentProject,
                        filename: currentFile,
                        content: editor.getValue()
                    });
                }, 500);
            }
        });

        socket.on('project_list', function(data) {
            const projectSelect = document.getElementById('project-select');
            projectSelect.innerHTML = '<option value="">Sélectionner un projet</option>';
            data.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelect.appendChild(option);
            });
        });

        socket.on('project_selected', function(data) {
            updateFileList(data.files);
        });

        socket.on('file_created', function(data) {
            updateFileList(data.files);
        });

        socket.on('file_renamed', function(data) {
            updateFileList(data.files);
            if (currentFile === data.old_name) {
                currentFile = data.new_name;
            }
        });

        socket.on('file_deleted', function(data) {
            updateFileList(data.files);
            if (currentFile === data.name) {
                currentFile = '';
                editor.setValue('');
                updateUIState();
            }
        });

        socket.on('file_saved', function(data) {
            showSaveStatus();
        });

        function updateFileList(files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            files.forEach(file => {
                const li = document.createElement('li');
                const fileSpan = document.createElement('span');
                fileSpan.textContent = file;
                li.appendChild(fileSpan);
                li.onclick = () => loadFile(file);
                fileList.appendChild(li);
            });
        }

        function selectProject() {
            const projectSelect = document.getElementById('project-select');
            currentProject = projectSelect.value;
            currentFile = '';
            editor.setValue('');
            
            if (currentProject) {
                socket.emit('select_project', {name: currentProject});
            }
            
            // Forcer la mise à jour de l'UI immédiatement après la sélection du projet
            updateUIState();
        }

        function loadFile(filename) {
            if (!currentProject) return;
            socket.emit('load_file', {filename: filename, project: currentProject});
            currentFile = filename;
            
            // Forcer la mise à jour de l'UI immédiatement après le chargement du fichier
            updateUIState();
        }

        socket.on('file_content', function(data) {
            isUpdating = true;
            editor.setValue(data.content, -1);
            currentFile = data.filename;
            updateUIState();
            isUpdating = false;

            // Changer le mode de l'éditeur en fonction du type de fichier
            if (currentFile.endsWith('.c')) {
                editor.session.setMode("ace/mode/c_cpp");
            } else {
                editor.session.setMode("ace/mode/python");
            }
        });

        function updateUIState() {
            const projectSelected = Boolean(currentProject);
            const fileSelected = Boolean(currentFile);
            
            // Récupération des boutons
            const executePythonBtn = document.getElementById('execute-python-btn');
            const executeCBtn = document.getElementById('execute-c-btn');
            const createFileBtn = document.getElementById('create-file-btn');
            const renameFileBtn = document.getElementById('rename-file-btn');
            const deleteFileBtn = document.getElementById('delete-file-btn');
            
            // Mise à jour des états des boutons
            createFileBtn.disabled = !projectSelected;
            renameFileBtn.disabled = !projectSelected || !fileSelected;
            deleteFileBtn.disabled = !projectSelected || !fileSelected;
            
            // Vérification du type de fichier seulement si un fichier est sélectionné
            if (fileSelected) {
                const isC = currentFile.endsWith('.c');
                const isPython = currentFile.endsWith('.py');
                
                executePythonBtn.disabled = !isPython;
                executeCBtn.disabled = !isC;
                
                // Activation du bon terminal
                switchTerminal(isC ? 'c' : 'python');
            } else {
                executePythonBtn.disabled = true;
                executeCBtn.disabled = true;
            }
            
            // Mise à jour de l'état de l'éditeur
            editor.setReadOnly(!projectSelected || !fileSelected);
        }

        // Gestion des curseurs collaboratifs
        socket.on('user_connected', function(data) {
            if (data.user_id !== localUserId) {
                createCursor(data.user_id, data.color);
            }
        });

        socket.on('user_disconnected', function(data) {
            if (cursors[data.user_id]) {
                cursors[data.user_id].cursor.remove();
                cursors[data.user_id].label.remove();
                delete cursors[data.user_id];
            }
        });

        socket.on('cursor_update', function(data) {
            if (data.user_id !== localUserId) {
                updateCursorPosition(data.user_id, data.position);
            }
        });

        function createCursor(userId, color) {
            const cursorElement = document.createElement('div');
            cursorElement.className = 'cursor';
            cursorElement.style.backgroundColor = color;

            const labelElement = document.createElement('div');
            labelElement.className = 'cursor-label';
            labelElement.style.backgroundColor = color;
            labelElement.textContent = `User ${userId.slice(0, 4)}`;

            cursors[userId] = {
                cursor: cursorElement,
                label: labelElement
            };

            document.getElementById('editor-container').appendChild(cursorElement);
            document.getElementById('editor-container').appendChild(labelElement);
        }

        function updateCursorPosition(userId, position) {
            if (!cursors[userId]) return;

            const pixelPosition = editor.renderer.textToScreenCoordinates(position.row, position.column);
            const cursor = cursors[userId].cursor;
            const label = cursors[userId].label;

            cursor.style.left = `${pixelPosition.pageX}px`;
            cursor.style.top = `${pixelPosition.pageY}px`;

            label.style.left = `${pixelPosition.pageX}px`;
            label.style.top = `${pixelPosition.pageY - 20}px`;
        }

        editor.session.selection.on('changeCursor', () => {
            if (currentProject && currentFile) {
                const position = editor.selection.getCursor();
                socket.emit('cursor_move', { position });
            }
        });

        function switchTerminal(type) {
            // Mettre à jour les onglets
            document.querySelectorAll('.terminal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${type}-tab`).classList.add('active');

            // Mettre à jour les terminaux
            document.querySelectorAll('.terminal').forEach(terminal => {
                terminal.classList.remove('active');
            });
            document.getElementById(`${type}-terminal`).classList.add('active');
        }

        function executeCode(type) {
            if (!currentProject || !currentFile) {
                const outputElement = document.getElementById(`${type}-output`);
                outputElement.innerHTML += `<span class="error">Erreur : Aucun fichier actif. Sélectionnez un fichier avant d'exécuter.</span>\n`;
                return;
            }

            // Vérification supplémentaire du type de fichier
            const fileType = currentFile.endsWith('.c') ? 'c' : 'python';
            if (fileType !== type) {
                const outputElement = document.getElementById(`${type}-output`);
                outputElement.innerHTML += `<span class="error">Erreur : Type de fichier incompatible avec ce terminal.</span>\n`;
                return;
            }

            const outputElement = document.getElementById(`${type}-output`);
            outputElement.innerHTML += `<span class="success">> Exécution de ${currentFile} dans le projet ${currentProject}...</span>\n`;

            socket.emit('execute_code', {
                project: currentProject,
                filename: currentFile,
                code: editor.getValue(),
                type: type
            });
        }

        function clearTerminal(type) {
            const outputElement = document.getElementById(`${type}-output`);
            outputElement.innerHTML = '';
        }
    </script>
</body>
</html>
